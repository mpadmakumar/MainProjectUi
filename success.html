<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment Status</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="message-container" class="text-center bg-white p-10 rounded-lg shadow-lg">
        <div id="loading-spinner">
            <svg class="animate-spin h-10 w-10 mx-auto text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h1 class="text-2xl font-semibold mt-4">Validating your order...</h1>
            <p class="text-gray-600">Please do not close this window.</p>
        </div>
        
        <div id="success-message" class="hidden">
             <h1 class="text-3xl font-bold text-green-600">Thank You!</h1>
             <p class="text-gray-700 mt-2">Your order has been placed successfully.</p>
             <p id="order-info" class="mt-4 text-lg"></p>
             <a href="index.html" class="mt-6 inline-block bg-yellow-600 text-white px-6 py-2 rounded-full hover:bg-yellow-700">Continue Shopping</a>
        </div>

        <div id="error-message" class="hidden">
            <h1 class="text-2xl font-semibold text-red-600">Error</h1>
            <p id="error-text" class="text-gray-600 mt-2"></p>
        </div>
    </div>
    
<script>
// helper functions to show messages
const showSuccess = (orderIdText) => {
    document.getElementById('loading-spinner').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');
    document.getElementById('success-message').classList.remove('hidden');
    document.getElementById('order-info').textContent = `Your Order ID is #${orderIdText}`;
};

const showError = (message) => {
    document.getElementById('loading-spinner').classList.add('hidden');
    document.getElementById('success-message').classList.add('hidden');
    document.getElementById('error-message').classList.remove('hidden');
    document.getElementById('error-text').textContent = message;
};


document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order_id');

    // ஆர்டர் ஐடி இல்லை என்றால், பிழையைக் காட்டு
    if (!orderId) {
        showError("Order ID not found. Cannot confirm order.");
        return;
    }

    // ✅ படி 1: இது COD ஆர்டரா என்று சோதிக்கவும்
    if (orderId.startsWith('COD')) {
        // இது COD ஆர்டர். ஆர்டர் ஏற்கெனவே டேட்டாபேஸில் சேமிக்கப்பட்டுவிட்டது.
        // எனவே, வெற்றிச் செய்தியைக் காட்டினால் மட்டும் போதும்.
        showSuccess(orderId);
        // இனி தேவைப்படாததால் localStorage-ஐ காலி செய்யவும்
        localStorage.removeItem('finalOrderDataForFulfillment');
        
    } else {
        // ✅ படி 2: இது Online Payment ஆர்டர்
        // பேமெண்ட்டுக்கு முன் சேமித்த ஆர்டர் விவரங்களை localStorage-இலிருந்து பெறவும்
        const finalOrderData = JSON.parse(localStorage.getItem('finalOrderDataForFulfillment'));

        if (finalOrderData) {
            // LocalStorage-இல் விவரங்கள் இருந்தால், Backend-க்கு அனுப்பி ஆர்டரை உறுதி செய்யவும்
            try {
                const requestData = { orderId: orderId, ...finalOrderData };

                const response = await fetch('https://mainprojectapi.onrender.com/fulfill-order-cashfree', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    showSuccess(result.orderId);
                    // ஆர்டர் முடிந்ததும் localStorage-ஐ காலி செய்யவும்
                    localStorage.removeItem('finalOrderDataForFulfillment');
                } else {
                    throw new Error(result.message || 'Failed to process order.');
                }

            } catch (error) {
                console.error(error);
                showError("There was an issue confirming your payment. Please contact support.");
            }
        } else {
            // Online Payment-ஆக இருந்து, localStorage-இல் தரவு இல்லை என்றால் பிழையைக் காண்பிக்கவும்
            showError("Could not find order details to confirm payment. Please contact support.");
        }
    }
});
</script>
</body>
</html>