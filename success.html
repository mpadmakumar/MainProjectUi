<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment Successful</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="message-container" class="text-center bg-white p-10 rounded-lg shadow-lg">
        <div id="loading-spinner">
            <svg class="animate-spin h-10 w-10 mx-auto text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h1 class="text-2xl font-semibold mt-4">Validating your payment...</h1>
            <p class="text-gray-600">Please do not close this window.</p>
        </div>
        
        <div id="success-message" class="hidden">
             <h1 class="text-3xl font-bold text-green-600">Thank You!</h1>
             <p class="text-gray-700 mt-2">Your payment was successful and your order has been placed.</p>
             <p id="order-info" class="mt-4 text-lg"></p>
             <a href="index.html" class="mt-6 inline-block bg-yellow-600 text-white px-6 py-2 rounded-full hover:bg-yellow-700">Continue Shopping</a>
        </div>
    </div>
    
   <script>
    document.addEventListener("DOMContentLoaded", async () => {
        // 1. URL-இலிருந்து Cashfree order_id-ஐப் பெறவும்
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');

        // 2. பேமெண்ட்டுக்கு முன் சேமித்த ஆர்டர் விவரங்களை localStorage-இலிருந்து பெறவும்
        const finalOrderData = JSON.parse(localStorage.getItem('finalOrderDataForFulfillment'));

        if (orderId && finalOrderData) {
            try {
                // 3. orderId மற்றும் ஆர்டர் விவரங்கள் இரண்டையும் இணைத்து Backend-க்கு அனுப்பவும்
                const requestData = {
                    orderId: orderId,
                    ...finalOrderData // finalOrderData-வில் உள்ள அனைத்தையும் இதனுடன் சேர்க்கவும்
                };

                // 4. புதிய Cashfree Servlet URL-ஐ அழைக்கவும்
                const response = await fetch('https://mainprojectapi.onrender.com/fulfill-order-cashfree', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const orderDetails = await response.json();

                if (orderDetails.status === 'success') {
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('success-message').classList.remove('hidden');
                    document.getElementById('order-info').textContent = `Your Order ID is #${orderDetails.orderId}`;
                    
                    // 5. ஆர்டர் முடிந்ததும் localStorage-ஐ காலி செய்யவும்
                    localStorage.removeItem('finalOrderDataForFulfillment');
                } else {
                    throw new Error(orderDetails.message || 'Failed to process order.');
                }

            } catch (error) {
                console.error(error);
                document.getElementById('message-container').innerHTML = `<h1 class="text-2xl font-semibold text-red-600">Error</h1><p>There was an issue confirming your order. Please contact support.</p>`;
            }
        } else {
            // order_id அல்லது localStorage-இல் தரவு இல்லை என்றால் பிழையைக் காண்பிக்கவும்
            document.getElementById('message-container').innerHTML = `<h1 class="text-2xl font-semibold text-red-600">Error</h1><p>Could not find order details to confirm payment. Please contact support.</p>`;
        }
    });
</script>
</body>
</html>