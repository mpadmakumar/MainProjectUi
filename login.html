<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Lustre covering</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { scroll-behavior: smooth; overflow-x: hidden; font-family: 'Poppins', sans-serif; }
        .bg-cover-image { background-image: url(./golden-jewelry1.jpeg); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-cover-image bg-cover bg-center min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white/90 backdrop-blur-sm shadow-2xl rounded-3xl p-8 md:p-12 space-y-8 animate-fade-in-up">
        <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-800 font-serif">Welcome Back</h2>

        <form id="loginForm" class="space-y-6">
            <div>
                <label for="uname" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <div class="relative">
                    <i class="fas fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="uname" name="uname" required placeholder="Enter your username" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition duration-200 ease-in-out" />
                </div>
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="password" name="password" required placeholder="Enter your password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition duration-200 ease-in-out" />
                </div>
                <p class="mt-2 text-sm text-right">
                    <button type="button" id="forgotPasswordBtn" class="text-yellow-600 hover:underline">Forgot Password?</button>
                </p>
            </div>

            <div id="messageContainer" class="min-h-[40px]"></div>

            <div class="flex flex-col gap-4">
                <button type="button" id="customerLoginBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 rounded-full flex justify-center items-center shadow-lg transition transform hover:scale-105 duration-200 ease-in-out">
                    <i class="fas fa-user mr-2"></i> Login as Customer
                </button>
                <button type="button" id="adminLoginBtn" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 rounded-full flex justify-center items-center shadow-lg transition transform hover:scale-105 duration-200 ease-in-out">
                    <i class="fas fa-user-shield mr-2"></i> Login as Admin
                </button>
            </div>

            <p class="text-sm text-center text-gray-600 mt-6">
                Don't have an account?
                <a href="register.html" class="text-yellow-600 hover:underline font-medium">Register here</a>
            </p>
        </form>
    </div>

    <div id="forgotPasswordModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Reset Your Password</h3>
            <p class="text-sm text-gray-600 mb-4">Enter your registered email address and we'll send you instructions to reset your password.</p>
            <input type="email" id="resetEmail" placeholder="Enter your email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:outline-none mb-4">
            <div id="resetMessage" class="min-h-[30px] mb-4"></div>
            <div class="flex justify-end gap-3">
                <button id="closeModal" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="sendResetBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg">Send Reset Link</button>
            </div>
        </div>
    </div>
    
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 flex flex-col items-center justify-center z-50">
        <div class="w-12 h-12 border-4 border-white/40 border-t-white rounded-full animate-spin mb-4"></div>
        <p class="text-white text-lg font-semibold">Redirecting...</p>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        // API endpoints
        const LOGIN_API_URL = "https://mainprojectapi.onrender.com/users/login";
        const FORGOT_PASSWORD_API_URL = "https://mainprojectapi.onrender.com/users/forgot-password";
        
        // Login Form elements
        const uname = document.getElementById("uname");
        const password = document.getElementById("password");
        const messageContainer = document.getElementById("messageContainer");
        const customerBtn = document.getElementById("customerLoginBtn");
        const adminBtn = document.getElementById("adminLoginBtn");

        // Forgot Password Modal elements
        const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");
        const forgotPasswordModal = document.getElementById("forgotPasswordModal");
        const closeModal = document.getElementById("closeModal");
        const sendResetBtn = document.getElementById("sendResetBtn");
        const resetEmail = document.getElementById("resetEmail");
        const resetMessage = document.getElementById("resetMessage");
        const loadingOverlay = document.getElementById("loadingOverlay");

        const showMessage = (msg, isSuccess, container = messageContainer) => {
            const alertClass = isSuccess 
                ? "bg-green-100 text-green-700 border border-green-400"
                : "bg-red-100 text-red-700 border border-red-400";
            const iconClass = isSuccess ? 'fa-check-circle' : 'fa-exclamation-triangle';
            container.innerHTML = `
                <div class="flex items-center p-3 rounded-md animate-fade-in ${alertClass}">
                    <i class="fas ${iconClass} mr-3"></i>
                    <span class="font-medium text-sm">${msg}</span>
                </div>
            `;
        };

        const setButtonLoading = (button, isLoading, text) => {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<svg class="spinner h-5 w-5 mr-2" viewBox="0 0 24 24"></svg> ${text}`;
            } else {
                button.disabled = false;
                if (button.id === "customerLoginBtn") {
                    button.innerHTML = `<i class="fas fa-user mr-2"></i> Login as Customer`;
                } else if (button.id === "adminLoginBtn") {
                    button.innerHTML = `<i class="fas fa-user-shield mr-2"></i> Login as Admin`;
                } else if (button.id === "sendResetBtn") {
                     button.innerHTML = "Send Reset Link";
                }
            }
        };

        const handleLogin = async (role) => {
            messageContainer.innerHTML = '';
            const currentButton = role === 'customer' ? customerBtn : adminBtn;
            
            if (!uname.value.trim() || !password.value.trim()) {
                showMessage("Please enter both username and password.", false);
                return;
            }

            setButtonLoading(currentButton, true, 'Logging in...');
            
            // Admin Login - Hardcoded
            if (role === 'admin') {
                if (uname.value === "admin" && password.value === "admin123") {
                    localStorage.setItem("isLoggedIn", "true");
                    // localStorage.setItem("userRole", "admin");
                    // localStorage.setItem("userData", JSON.stringify({
                    //     name: "Admin",
                    //     email: "admin@system.com",
                    //     initial: "A"
                    // }));
                    showMessage("Admin Login successful! Redirecting...", true);
                    loadingOverlay.classList.remove("hidden");
                    setTimeout(() => { window.location.href = "admin-dashboard.html"; }, 2000);
                } else {
                    showMessage("Invalid admin credentials.", false);
                    setButtonLoading(currentButton, false);
                }
                return;
            }

            // Customer Login - API Call (URL-encoded)
            const formData = new URLSearchParams();
            formData.append("uname", uname.value.trim());
            formData.append("password", password.value.trim());

            try {
                const res = await fetch(LOGIN_API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData
                });

                const data = await res.json();
                
                if (data.success) {
                    localStorage.setItem("isLoggedIn", "true");
                    localStorage.setItem("userRole", "customer");
                    localStorage.setItem("userData", JSON.stringify({
                        name: uname.value.trim(),
                        email: `${uname.value.trim()}@gmail.com`,
                        initial: uname.value.trim().charAt(0).toUpperCase()
                    }));
                    showMessage("Login successful! Redirecting...", true);
                    loadingOverlay.classList.remove("hidden");
                    setTimeout(() => { window.location.href = "index.html"; }, 2000);
                } else {
                    showMessage(data.message || "Login failed. Please check your credentials.", false);
                }
            } catch (err) {
                console.error(err);
                showMessage("Network error. Please try again.", false);
            } finally {
                setButtonLoading(currentButton, false, '');
            }
        };

        // Event Listeners for Login Buttons
        customerBtn.addEventListener("click", () => handleLogin('customer'));
        adminBtn.addEventListener("click", () => handleLogin('admin'));

        // Forgot password modal functionality
        forgotPasswordBtn.addEventListener("click", () => {
            forgotPasswordModal.classList.remove("hidden");
            resetMessage.innerHTML = "";
            resetEmail.value = "";
        });

        closeModal.addEventListener("click", () => {
            forgotPasswordModal.classList.add("hidden");
        });

        // Send reset link handler - Using JSON body
        sendResetBtn.addEventListener("click", async () => {
            resetMessage.innerHTML = "";
            const email = resetEmail.value.trim();

            if (!email) {
                showMessage("Please enter your registered email.", false, resetMessage);
                return;
            }

            sendResetBtn.innerHTML = `<svg class="spinner h-5 w-5 inline mr-2" viewBox="0 0 24 24"></svg> Sending...`;
            sendResetBtn.disabled = true;

            try {
                const res = await fetch(FORGOT_PASSWORD_API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }, // Changed to JSON
                    body: JSON.stringify({ email: email }) // Changed to JSON
                });
                
                const data = await res.json();
                
                // For security, server often sends a generic success message
                showMessage(data.message || "If this email exists, a reset link has been sent.", true, resetMessage);
                
                setTimeout(() => {
                    if (data.success) {
                        forgotPasswordModal.classList.add("hidden");
                    }
                }, 3000);

            } catch (error) {
                console.error("Forgot Password Error:", error);
                showMessage("Something went wrong. Please try again.", false, resetMessage);
            } finally {
                setButtonLoading(sendResetBtn, false, '');
            }
        });
    });
    </script>
</body>
</html>