<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Lustre covering</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { scroll-behavior: smooth; overflow-x: hidden; font-family: 'Poppins', sans-serif; }
        .bg-cover-image { background-image: url(./golden-jewelry1.jpeg); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .otp-input { width: 40px; height: 50px; text-align: center; font-size: 1.25rem; border-radius: 0.5rem; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="bg-cover-image bg-cover bg-center min-h-screen flex items-center justify-center p-4">

    <!-- Main Login/OTP Form Container -->
    <div id="main-login-container" class="w-full max-w-md bg-white/95 backdrop-blur-sm shadow-2xl rounded-3xl p-8 md:p-12 space-y-8 animate-fade-in">
        <h2 id="formTitle" class="text-3xl md:text-4xl font-bold text-center text-gray-800 font-serif">Welcome Back</h2>

        <!-- Step 1: Credentials Form -->
        <form id="credentialForm" class="space-y-6">
            <div>
                <label for="uname" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <div class="relative"><i class="fas fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" id="uname" name="uname" required placeholder="Enter your username" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" /></div>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <div class="relative"><i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="password" id="password" name="password" required placeholder="Enter your password" class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" /><button type="button" id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"><i class="fas fa-eye"></i></button></div>
            </div>
            <div class="text-right text-sm"><a href="#" id="forgotPasswordLink" class="font-medium text-yellow-600 hover:text-yellow-500 hover:underline">Forgot Password?</a></div>
            <div id="messageContainer" class="min-h-[40px]"></div>
            <button type="submit" id="sendOtpBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 rounded-full flex justify-center items-center shadow-lg transition transform hover:scale-105"><span>Send OTP</span></button>
        </form>

        <!-- Step 2: Login OTP Verification Form (Initially Hidden) -->
        <form id="otpForm" class="hidden space-y-6">
             <p class="text-center text-gray-600">An OTP has been sent to your registered email. Please enter it below.</p>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Enter 6-Digit OTP</label>
                <div id="otp-inputs" class="flex justify-center gap-2">
                    <input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" />
                </div>
            </div>
            <div id="otpMessageContainer" class="min-h-[40px]"></div>
            <button type="submit" id="verifyOtpBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-full flex justify-center items-center shadow-lg"><span>Verify & Login</span></button>
            <button type="button" id="backToLoginBtn" class="w-full text-center text-sm text-gray-600 hover:underline mt-2">Back to Login</button>
        </form>
        
        <p class="text-sm text-center text-gray-600">Don't have an account? <a href="register.html" class="text-yellow-600 hover:underline font-medium">Register here</a></p>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-6 animate-fade-in">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            <h2 id="modalTitle" class="text-2xl font-bold text-center text-gray-800">Reset Password</h2>
            <!-- Step 1: Enter Email -->
            <div id="step1-email" class="space-y-4">
                <p class="text-center text-gray-600">Enter your registered email to receive an OTP.</p>
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="reset-email" placeholder="you@example.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                </div>
                <button id="sendResetOtpBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 rounded-full flex justify-center items-center"><span>Send OTP</span></button>
            </div>
            <!-- Step 2: Verify OTP -->
            <div id="step2-otp" class="hidden space-y-4">
                 <p class="text-center text-gray-600">An OTP has been sent. Please enter it below.</p>
                 <div class="flex justify-center gap-2" id="reset-otp-inputs">
                    <input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" /><input type="text" maxlength="1" class="otp-input" />
                </div>
                <button id="verifyResetOtpBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-full flex justify-center items-center"><span>Verify OTP</span></button>
            </div>
            <!-- Step 3: Reset Password -->
            <div id="step3-password" class="hidden space-y-4">
                <p class="text-center text-gray-600">Create a new password for your account.</p>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                    <input type="password" id="new-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                </div>
                 <div>
                    <label for="confirm-new-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                </div>
                <button id="updatePasswordBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-full flex justify-center items-center"><span>Update Password</span></button>
            </div>
            <div id="resetMessage" class="min-h-[40px] mt-4"></div>
        </div>
    </div>
    
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 flex flex-col items-center justify-center z-50"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- API Endpoints ---
    const REQUEST_OTP_API = "https://mainprojectapi.onrender.com/users/request-otp";
    const VERIFY_OTP_API = "https://mainprojectapi.onrender.com/users/verify-otp";
    const FORGOT_PASSWORD_API_URL = "https://mainprojectapi.onrender.com/users/forgot-password";
    const VERIFY_RESET_OTP_API_URL = "https://mainprojectapi.onrender.com/users/verify-reset-otp";
    const UPDATE_PASSWORD_API_URL = "https://mainprojectapi.onrender.com/users/update-password";

    // --- Main Login Selectors ---
    const formTitle = document.getElementById("formTitle");
    const credentialForm = document.getElementById("credentialForm");
    const otpForm = document.getElementById("otpForm");
    const unameInput = document.getElementById("uname");
    const passwordInput = document.getElementById("password");
    const togglePasswordBtn = document.getElementById("togglePassword");
    const sendOtpBtn = document.getElementById("sendOtpBtn");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const backToLoginBtn = document.getElementById("backToLoginBtn");
    const otpInputs = document.querySelectorAll("#otp-inputs input");
    const messageContainer = document.getElementById("messageContainer");
    const otpMessageContainer = document.getElementById("otpMessageContainer");
    const loadingOverlay = document.getElementById("loadingOverlay");

    // --- Forgot Password Modal Selectors ---
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const step1 = document.getElementById('step1-email');
    const step2 = document.getElementById('step2-otp');
    const step3 = document.getElementById('step3-password');
    const sendResetOtpBtn = document.getElementById('sendResetOtpBtn');
    const verifyResetOtpBtn = document.getElementById('verifyResetOtpBtn');
    const updatePasswordBtn = document.getElementById('updatePasswordBtn');
    const resetEmailInput = document.getElementById('reset-email');
    const resetOtpInputs = document.querySelectorAll('#reset-otp-inputs input');
    const newPasswordInput = document.getElementById('new-password');
    const confirmNewPasswordInput = document.getElementById('confirm-new-password');
    const resetMessage = document.getElementById('resetMessage');

    let currentUsername = "";
    let userEmailForReset = "";
    let verifiedOtpForReset = "";

    // --- Universal Helper Functions ---
    const showMessage = (msg, isSuccess, container) => {
        const targetContainer = container || messageContainer;
        const alertClass = isSuccess ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700";
        targetContainer.innerHTML = `<div class="p-3 rounded-md animate-fade-in ${alertClass}">${msg}</div>`;
    };

    const setButtonLoading = (button, isLoading, text) => {
        button.disabled = isLoading;
        const originalText = button.querySelector('span')?.textContent || 'Submit';
        if (isLoading) {
            button.innerHTML = `<svg class="spinner h-5 w-5 mr-2" viewBox="0 0 24 24"></svg> ${text}`;
        } else {
            button.innerHTML = `<span>${originalText}</span>`;
        }
    };

    // --- Login Flow UI Functions ---
    const switchToOtpStep = () => {
        formTitle.textContent = "Verify Your Identity";
        credentialForm.classList.add('hidden');
        otpForm.classList.remove('hidden');
        otpInputs[0].focus();
    };
    const switchToLoginStep = () => {
        formTitle.textContent = "Welcome Back";
        credentialForm.classList.remove('hidden');
        otpForm.classList.add('hidden');
        messageContainer.innerHTML = '';
        otpMessageContainer.innerHTML = '';
        currentUsername = "";
    };

    // --- Event Listener for Show/Hide Password ---
    togglePasswordBtn.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        const icon = togglePasswordBtn.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    });
    
    // --- Event Listeners for OTP Input handling ---
    [...otpInputs, ...resetOtpInputs].forEach((input, index, arr) => {
        const parentId = input.parentElement.id;
        input.addEventListener('input', () => { 
            if (input.value && index < arr.length - 1) {
                const nextInput = arr[index + 1];
                if (nextInput.parentElement.id === parentId) nextInput.focus();
            }
        });
        input.addEventListener('keydown', (e) => { 
            if (e.key === "Backspace" && !input.value && index > 0) {
                 const prevInput = arr[index - 1];
                 if (prevInput.parentElement.id === parentId) prevInput.focus();
            }
        });
    });

    // --- Login Flow Event Listeners ---
    backToLoginBtn.addEventListener('click', switchToLoginStep);
    
    credentialForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        messageContainer.innerHTML = '';
        const username = unameInput.value.trim();
        const password = passwordInput.value.trim();
        currentUsername = username;
        if (!username || !password) { showMessage("Please enter both username and password.", false); return; }
        setButtonLoading(sendOtpBtn, true, 'Sending...');

        if (username === "admin" && password === "admin123") {
            // localStorage.setItem("isLoggedIn", "true");
            // localStorage.setItem("userRole", "admin");
            // localStorage.setItem("userData", JSON.stringify({ name: "Admin", initial: "A" }));
            showMessage("Admin Login successful! Redirecting...", true);
            loadingOverlay.classList.remove("hidden");
            setTimeout(() => { window.location.href = "admin-dashboard.html"; }, 1500);
            return;
        }

        try {
            const formData = new URLSearchParams();
            formData.append("uname", username);
            formData.append("password", password);
            const response = await fetch(REQUEST_OTP_API, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: formData });
            const result = await response.json();
            if (result.success) {
                showMessage(result.message, true);
                switchToOtpStep();
            } else {
                showMessage(result.message || "Failed to send OTP.", false);
            }
        } catch (err) { showMessage("Network error. Please try again.", false); } finally { setButtonLoading(sendOtpBtn, false); }
    });

    otpForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        let otp = Array.from(otpInputs).map(input => input.value).join('');
        if (otp.length !== 6) { showMessage("Please enter the 6-digit OTP.", false, otpMessageContainer); return; }
        setButtonLoading(verifyOtpBtn, true, 'Verifying...');

        try {
            const formData = new URLSearchParams();
            formData.append("uname", currentUsername);
            formData.append("otp", otp);
            const response = await fetch(VERIFY_OTP_API, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: formData });
            const result = await response.json();
            if (result.success) {
                localStorage.setItem("isLoggedIn", "true");
                localStorage.setItem("userRole", "customer");
                localStorage.setItem("userData", JSON.stringify({ name: currentUsername, initial: currentUsername.charAt(0).toUpperCase() }));
                showMessage("Login successful! Redirecting...", true, otpMessageContainer);
                loadingOverlay.classList.remove("hidden");
                setTimeout(() => { window.location.replace("index.html"); }, 1500);
            } else { showMessage(result.message || "Verification failed.", false, otpMessageContainer); }
        } catch (err) { showMessage("Network error. Please try again.", false, otpMessageContainer); }
        finally { setButtonLoading(verifyOtpBtn, false); }
    });

    // --- Forgot Password Flow Event Listeners ---
    const resetModal = () => {
        step1.classList.remove('hidden');
        step2.classList.add('hidden');
        step3.classList.add('hidden');
        resetMessage.innerHTML = '';
        resetEmailInput.value = '';
        resetOtpInputs.forEach(i => i.value = '');
        newPasswordInput.value = '';
        confirmNewPasswordInput.value = '';
        userEmailForReset = "";
        verifiedOtpForReset = "";
    };
    forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); resetModal(); forgotPasswordModal.classList.remove('hidden'); });
    closeModalBtn.addEventListener('click', () => { forgotPasswordModal.classList.add('hidden'); });

    sendResetOtpBtn.addEventListener('click', async () => {
        userEmailForReset = resetEmailInput.value.trim();
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(userEmailForReset)) { showMessage("Please enter a valid email address.", false, resetMessage); return; }
        setButtonLoading(sendResetOtpBtn, true, 'Sending...');
        try {
            const res = await fetch(FORGOT_PASSWORD_API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: userEmailForReset }) });
            const data = await res.json();
            if (data.success) {
                showMessage(data.message, true, resetMessage);
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                resetOtpInputs[0].focus();
            } else { showMessage(data.message, false, resetMessage); }
        } catch(err) { showMessage("Network error.", false, resetMessage); }
        finally { setButtonLoading(sendResetOtpBtn, false); }
    });
    verifyResetOtpBtn.addEventListener('click', async () => {
        let otp = Array.from(resetOtpInputs).map(input => input.value).join('');
        if (otp.length !== 6) { showMessage("Please enter the 6-digit OTP.", false, resetMessage); return; }
        verifiedOtpForReset = otp;
        setButtonLoading(verifyResetOtpBtn, true, 'Verifying...');
        try {
            const res = await fetch(VERIFY_RESET_OTP_API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: userEmailForReset, otp: otp }) });
            const data = await res.json();
            if (data.success) {
                showMessage("OTP verified. Please set a new password.", true, resetMessage);
                step2.classList.add('hidden');
                step3.classList.remove('hidden');
                newPasswordInput.focus();
            } else { showMessage(data.message, false, resetMessage); }
        } catch(err) { showMessage("Network error.", false, resetMessage); }
        finally { setButtonLoading(verifyResetOtpBtn, false); }
    });
    updatePasswordBtn.addEventListener('click', async () => {
        const newPassword = newPasswordInput.value;
        const confirmNewPassword = confirmNewPasswordInput.value;
        if (newPassword.length < 8) { showMessage("Password must be at least 8 characters.", false, resetMessage); return; }
        if (newPassword !== confirmNewPassword) { showMessage("Passwords do not match.", false, resetMessage); return; }
        setButtonLoading(updatePasswordBtn, true, 'Updating...');
        try {
            const res = await fetch(UPDATE_PASSWORD_API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: userEmailForReset, otp: verifiedOtpForReset, newPassword: newPassword }) });
            const data = await res.json();
            if (data.success) {
                showMessage("Password updated successfully! You can now login.", true, resetMessage);
                setTimeout(() => { forgotPasswordModal.classList.add('hidden'); }, 3000);
            } else { showMessage(data.message, false, resetMessage); }
        } catch (err) { showMessage("Network error.", false, resetMessage); }
        finally { setButtonLoading(updatePasswordBtn, false); }
    });
});
</script>
</body>
</html>

